---
- type: replace
  path: /instance_groups/name=isolated-doppler/jobs/name=log-cache?
  value:
    name: log-cache
    release: log-cache
    provides:
      log-cache: {as: isolated_log_cache, shared: true}
    consumes:
      log-cache: {from: isolated_log_cache}
    properties:
      egress_port: 8080
      health_addr: "localhost:6060"
      tls:
        ca_cert: "((isolated_log_cache.ca))"
        cert: "((isolated_log_cache.certificate))"
        key: "((isolated_log_cache.private_key))"

- type: replace
  path: /instance_groups/name=isolated-doppler/jobs/name=log-cache-cf-auth-proxy?
  value:
    name: log-cache-cf-auth-proxy
    consumes:
      log-cache: {from: isolated_log_cache}
      log-cache-gateway: {from: isolated_log_cache_gateway}
    properties:
      cc:
        ca_cert: ((isolated_log_cache_tls_cc_auth_proxy.ca))
        capi_internal_addr: https://cloud-controller-ng.service.cf.internal:9023
        cert: ((isolated_log_cache_tls_cc_auth_proxy.certificate))
        common_name: cloud-controller-ng.service.cf.internal
        key: ((isolated_log_cache_tls_cc_auth_proxy.private_key))
      proxy_port: 8083
      uaa:
        ca_cert: ((uaa_ca.certificate))
        client_id: doppler
        client_secret: ((uaa_clients_doppler_secret))
        internal_addr: https://uaa.service.cf.internal:8443
    release: log-cache

- type: replace
  path: /instance_groups/name=isolated-doppler/jobs/name=log-cache-expvar-forwarder?
  value:
    name: log-cache-expvar-forwarder
    release: log-cache
    consumes:
      log-cache: {from: isolated_log_cache}
    properties:
      maps: []
      counters:
      - {name: egress,         source_id: isolated-log-cache,        addr: "http://localhost:6060/debug/vars", template: "{{.LogCache.Egress}}"}
      - {name: ingress,        source_id: isolated-log-cache,        addr: "http://localhost:6060/debug/vars", template: "{{.LogCache.Ingress}}"}
      - {name: expired,        source_id: isolated-log-cache,        addr: "http://localhost:6060/debug/vars", template: "{{.LogCache.Expired}}"}
      - {name: dropped,        source_id: isolated-log-cache,        addr: "http://localhost:6060/debug/vars", template: "{{.LogCache.Dropped}}"}
      - {name: promql-timeout, source_id: isolated-log-cache,        addr: "http://localhost:6060/debug/vars", template: "{{.LogCache.PromQLTimeout}}"}
      - {name: egress,         source_id: isolated-log-cache-nozzle, addr: "http://localhost:6061/debug/vars", template: "{{.Nozzle.Egress}}"}
      - {name: ingress,        source_id: isolated-log-cache-nozzle, addr: "http://localhost:6061/debug/vars", template: "{{.Nozzle.Ingress}}"}
      - {name: err,            source_id: isolated-log-cache-nozzle, addr: "http://localhost:6061/debug/vars", template: "{{.Nozzle.Err}}"}
      - {name: dropped,        source_id: isolated-log-cache-nozzle, addr: "http://localhost:6061/debug/vars", template: "{{.Nozzle.Dropped}}"}
      gauges:
      - {name: cache-period,                                source_id: isolated-log-cache,               addr: "http://localhost:6060/debug/vars", template: "{{.LogCache.CachePeriod}}"}
      - {name: store-size,                                  source_id: isolated-log-cache,               addr: "http://localhost:6060/debug/vars", template: "{{.LogCache.StoreSize}}"}
      - {name: total-system-memory,                         source_id: isolated-log-cache,               addr: "http://localhost:6060/debug/vars", template: "{{.LogCache.TotalSystemMemory}}"}
      - {name: available-system-memory,                     source_id: isolated-log-cache,               addr: "http://localhost:6060/debug/vars", template: "{{.LogCache.AvailableSystemMemory}}"}
      - {name: promql-instant-query-time,                   source_id: isolated-log-cache,               addr: "http://localhost:6060/debug/vars", template: "{{.LogCache.PromQLInstantQueryTime}}"}
      - {name: promql-range-query-time,                     source_id: isolated-log-cache,               addr: "http://localhost:6060/debug/vars", template: "{{.LogCache.PromQLRangeQueryTime}}"}
      - {name: last-uaa-latency,                            source_id: isolated-log-cache-cf-auth-proxy, addr: "http://localhost:6065/debug/vars", template: "{{.CFAuthProxy.LastUAALatency}}"}
      - {name: last-capi-v3-apps-latency,                   source_id: isolated-log-cache-cf-auth-proxy, addr: "http://localhost:6065/debug/vars", template: "{{.CFAuthProxy.LastCAPIV3AppsLatency}}"}
      - {name: last-capi-v2-list-service-instances-latency, source_id: isolated-log-cache-cf-auth-proxy, addr: "http://localhost:6065/debug/vars", template: "{{.CFAuthProxy.LastCAPIV2ListServiceInstancesLatency}}"}
      - {name: last-capi-v4-log-access-latency,             source_id: isolated-log-cache-cf-auth-proxy, addr: "http://localhost:6065/debug/vars", template: "{{.CFAuthProxy.LastCAPIV4LogAccessLatency}}"}
      - {name: last-capi-v2-service-instances-latency,      source_id: isolated-log-cache-cf-auth-proxy, addr: "http://localhost:6065/debug/vars", template: "{{.CFAuthProxy.LastCAPIV2ServiceInstancesLatency}}"}

- type: replace
  path: /instance_groups/name=isolated-doppler/jobs/name=log-cache-gateway?
  value:
    name: log-cache-gateway
    release: log-cache
    consumes:
      log-cache: {from: isolated_log_cache}
    provides:
      log-cache-gateway: {as: isolated_log_cache_gateway, shared: true}

- type: replace
  path: /instance_groups/name=isolated-doppler/jobs/name=log-cache-nozzle?
  value:
    name: log-cache-nozzle
    release: log-cache
    consumes:
      reverse_log_proxy: {from: isolated_reverse_log_proxy}
      log-cache: {from: isolated_log_cache}
    properties:
      logs_provider:
        tls:
          ca_cert: "((isolated_logs_provider.ca))"
          cert: "((isolated_logs_provider.certificate))"
          key: "((isolated_logs_provider.private_key))"

- type: replace
  path: /instance_groups/name=isolated-doppler/jobs/name=route_registrar?
  value:
    name: route_registrar
    release: routing
    properties:
      route_registrar:
        routes:
        - name: isolated-log-cache-reverse-log-proxy
          port: 8083
          registration_interval: 20s
          uris:
          - iso-log-cache.((system_domain))
          - "*.iso-log-cache.((system_domain))"

- type: replace
  path: /instance_groups/name=isolated-scheduler?
  value:
    name: isolated-scheduler
    azs:
    - z1
    - z2
    instances: 1
    persistent_disk_type: 5GB
    vm_type: minimal
    stemcell: default
    networks:
    - name: default
    jobs:
    - name: log-cache-scheduler
      release: log-cache
      consumes:
        log-cache: {from: isolated_log_cache}
    - name: log-cache-expvar-forwarder
      release: log-cache
      consumes:
        log-cache: {from: isolated_log_cache}
      properties:
        counters: []
        gauges: []
        maps:
        - {name: worker-assignments, source_id: isolated-log-cache-scheduler, addr: "http://localhost:6064/debug/vars", template: "{{.WorkerAssignments | jsonMap}}"}
        - {name: worker-health,      source_id: isolated-log-cache-scheduler, addr: "http://localhost:6064/debug/vars", template: "{{.WorkerHealth | jsonMap}}"}

- type: replace
  path: /variables/name=isolated_logs_provider?
  value:
    name: isolated_logs_provider
    type: certificate
    options:
      ca: isolated_loggregator_ca
      common_name: isolated-log-cache
      extended_key_usage:
      - client_auth
      - server_auth

- type: replace
  path: /variables/name=isolated_log_cache_ca?
  value:
    name: isolated_log_cache_ca
    type: certificate
    options:
      is_ca: true
      common_name: isolated-log-cache

- type: replace
  path: /variables/name=isolated_log_cache?
  value:
    name: isolated_log_cache
    type: certificate
    options:
      ca: isolated_log_cache_ca
      common_name: log-cache
      alternative_names:
      - log_cache
      - log-cache
      extended_key_usage:
      - client_auth
      - server_auth

- type: replace
  path: /variables/name=isolated_log_cache_tls_cc_auth_proxy?
  value:
    name: isolated_log_cache_tls_cc_auth_proxy
    options:
      ca: service_cf_internal_ca
      common_name: isolated-log-cache
      extended_key_usage:
      - client_auth
    type: certificate

- type: replace
  path: /instance_groups/name=isolated-log-api/jobs/name=loggregator_trafficcontroller/consumes/log-cache?
  value:
    from: isolated_log_cache

- type: replace
  path: /instance_groups/name=api/jobs/name=cloud_controller_ng/consumes?/log-cache?
  value:
    from: log_cache

- type: replace
  path: /instance_groups/name=doppler/jobs/name=log-cache/consumes?/log-cache?
  value:
    from: log_cache

- type: replace
  path: /instance_groups/name=doppler/jobs/name=log-cache/provides/log-cache?
  value:
    as: log_cache
    shared: true

- type: replace
  path: /instance_groups/name=doppler/jobs/name=log-cache-cf-auth-proxy/consumes?/log-cache?
  value:
    from: log_cache

- type: replace
  path: /instance_groups/name=doppler/jobs/name=log-cache-cf-auth-proxy/consumes?/log-cache-gateway?
  value:
    from: log_cache_gateway

- type: replace
  path: /instance_groups/name=doppler/jobs/name=log-cache-expvar-forwarder/consumes?/log-cache?
  value:
    from: log_cache

- type: replace
  path: /instance_groups/name=doppler/jobs/name=log-cache-gateway/consumes?/log-cache?
  value:
    from: log_cache

- type: replace
  path: /instance_groups/name=doppler/jobs/name=log-cache-gateway/provides?/log-cache-gateway?
  value:
    as: log_cache_gateway
    shared: true

- type: replace
  path: /instance_groups/name=doppler/jobs/name=log-cache-nozzle/consumes?/log-cache?
  value:
    from: log_cache

- type: replace
  path: /instance_groups/name=log-api/jobs/name=loggregator_trafficcontroller/consumes?/log-cache?
  value:
    from: log_cache

- type: replace
  path: /instance_groups/name=scheduler/jobs/name=log-cache-expvar-forwarder/consumes?/log-cache?
  value:
    from: log_cache

- type: replace
  path: /instance_groups/name=scheduler/jobs/name=log-cache-scheduler/consumes?/log-cache?
  value:
    from: log_cache
